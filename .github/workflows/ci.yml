---
name: Week 6 CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:

  terraform:
    name: Terraform Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Validate Terraform ESXi
        run: |
          cd terraform/esxi
          terraform init -backend=false
          terraform validate

      - name: Validate Terraform Azure
        run: |
          cd terraform/azure
          terraform init -backend=false
          terraform validate

  ansible-syntax:
    name: Ansible Syntax Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Ansible
        run: sudo apt-get update && sudo apt-get install -y ansible ansible-lint yamllint

      - name: Run syntax check on playbook
        run: ansible-playbook ansible/site.yml --syntax-check

  ansible-lint:
    name: Ansible Lint + Yamllint
    runs-on: ubuntu-latest
    needs: ansible-syntax
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install linters
        run: sudo apt-get update && sudo apt-get install -y ansible-lint yamllint

      - name: Run ansible-lint
        run: ansible-lint ansible/ || true   # laat lint-fouten zien maar stopt niet

      - name: Run yamllint
        run: yamllint ansible/ terraform/

  ansible-checkmode:
    name: Ansible Dry-Run
    runs-on: ubuntu-latest
    needs: [ansible-lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Ansible
        run: sudo apt-get update && sudo apt-get install -y ansible

      - name: Run playbook in check-mode
        run: ansible-playbook ansible/site.yml --check
